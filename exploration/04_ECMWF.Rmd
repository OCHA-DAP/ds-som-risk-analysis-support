---
title: "ECMWF"
output: html_document
date: "2023-10-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(tidyverse)
library(ncdf4)
library(terra)
fp_seas51 <- file.path(
  Sys.getenv("AA_DATA_DIR"),
  "private",
  "raw",
  "som",
  "ecmwf_seasonal",
  "seas51"
)

som_adm_levels <- c(
  "som_admbnda_adm0_ocha_20230308",
  "som_admbnda_adm1_ocha_20230308",
  "som_admbnda_adm2_ocha_20230308"
)

som_adm <- som_adm_levels %>%
  map(
    ~ search_datasets("Somalia - Subnational Administrative Boundaries") %>%
      pluck(1) %>%
      get_resource(2) %>%
      read_resource(layer = .x) %>%
      clean_names() %>%
      select(matches("^adm\\d_"))
  ) %>%
  set_names(c("adm0", "adm1", "adm2"))
```




```{r}

# I later manually downloaded the files from the ECMWF website to double check
# therefore, I have to filter out the manually downloaded files first
idx_manually_downloaded_fp <- str_detect(dir(fp_seas51),"manual")
fnames <- dir(fp_seas51)[!idx_manually_downloaded_fp]


# list of rasters
lr <- fnames %>%
  map(
    \(fname){
      fp <- file.path(fp_seas51, fname)
      nf <- nc_open(fp)

      # get precipitation rate
      # it's 4D for each value there is 1. lat, 2. lon, 3. ensemble, 4. time)
      tprate_array <- ncvar_get(nf, "tprate")

      # get fill value
      fill_value <- ncatt_get(nf, "tprate", "_FillValue")

      # fill array w/ standard NA
      tprate_array[tprate_array == fill_value$value] <- NA
      tprate_mean_array <- apply(tprate_array, c(1, 2), mean, na.rm = T)


      lon <- ncvar_get(nf, "longitude")
      lat <- ncvar_get(nf, "latitude", verbose = F)
      t_hours <- ncvar_get(nf, "time")

      r <- rast(
        x = aperm(tprate_mean_array, c(2, 1)),
        extent = ext(
          min(lon) - .5,
          max(lon) + .5,
          min(lat) - .5,
          max(lat) + 0.5
        ),
        crs = "EPSG:4326"
      )


      dates_predicted <- as_date(as_date("1900-01-01") + hours(t_hours))
      set.names(r, dates_predicted)
      return(r)
    }
  ) %>%
  set_names(fnames)

```

# Sum 3 rasters for JFM

we don't have to worry about units bc we are just going to run a ranking on the values

```{r}
r_ecmwf <-  rast(lr)
r_emwf_sum <- sum(r_ecmwf)
```

## Zonal stats per admin 1

```{r}
 df_ecmwf_adm1 <- exact_extract(
      x = r_emwf_sum,
      y = som_adm$adm1,
      fun = "mean",
      append_cols= "adm1_en"
    ) %>%
      pivot_longer(-adm1_en) %>%
      separate(name, into = c("stat", "date"), sep = "\\.") %>%
      pivot_wider(names_from = "stat", values_from = "value") 


# rank rainfall
df_ecmwf_adm1_ranked <- df_ecmwf_adm1 %>% 
  arrange(desc(mean)) %>% 
  mutate(
    rank = row_number()
  )

# join to shapefile
gdf_adm1_ranked <- som_adm$adm1 %>% 
  left_join(df_ecmwf_adm1_ranked, by = c("adm1_en" = "adm1_en")) 

# map ranks
gdf_adm1_ranked %>% 
  ggplot()+
  geom_sf(
    aes(fill=as.ordered(rank))
  )+
  theme(
    legend.title = element_blank()
  )

```


# Quick check manual DL

```{r}
# get index of manually downloaded file
manual_file <- dir(fp_seas51)[idx_manually_downloaded_fp]
fp_manual_dl <- file.path(fp_seas51,manual_file)
nf <- nc_open(fp_manual_dl)

# get precipitation rate
# it's 3D for each value there is 1. lat, 2. lon, 3. ensemble, 4. time)
tprate_array <- ncvar_get(nf, "tprate")

# get fill value
fill_value <- ncatt_get(nf, "tprate", "_FillValue")

# fill array w/ standard NA
tprate_array[tprate_array == fill_value$value] <- NA
# tprate_mean_array <- apply(tprate_array, c(1, 2), mean, na.rm = T)



lon <- ncvar_get(nf, "longitude")
lat <- ncvar_get(nf, "latitude", verbose = F)
t_hours <- ncvar_get(nf, "time")


r_dld <- rast(
  x = aperm(tprate_array,c(2,1,3)),
  extent = ext(
    min(lon) - .5,
    max(lon) + .5,
    min(lat) - .5,
    max(lat) + 0.5
  ),
  crs = "EPSG:4326"
)


dates_predicted <- as_date(as_datetime("1900-01-01 00:00:00") + hours(t_hours))
set.names(r, dates_predicted)

r_dld      
```
