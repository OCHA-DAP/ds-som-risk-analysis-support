---
title: "Floodscan Explore"
output: 
    bookdown::html_document2:
        toc: true
        toc_float: true
        toc_depth: 3
        code_folding: hide
date: "2023-10-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE, 
  eval = TRUE,
  results = "hide",
  out.width= "100%"
)
```

# Intro

This is the start of an analysis looking at the utility of FloodScan for this research. This analysis is largely **incomplete** and most likely out of scope of project goals so will put on pause.

```{r libsData}
library(tidyverse)
library(sf)
library(tidync)
library(rhdx)
library(exactextractr)
library(janitor)
library(terra)
library(glue)
library(exactextractr)
library(here)
library(gghdx)
# these are for appendix
library(readxl) # read in prmn
library(gganimate)
library(magick)
source(here("R/utils_floodscan.R"))
gghdx()

som_adm0_levels <- c(
  "som_admbnda_adm0_ocha_20230308",
  "som_admbnda_adm1_ocha_20230308",
  "som_admbnda_adm2_ocha_20230308"
)

som_adm <- som_adm0_levels %>%
  map(
    ~ search_datasets("Somalia - Subnational Administrative Boundaries") %>%
      pluck(1) %>%
      get_resource(2) %>%
      read_resource(layer = .x) %>%
      clean_names() %>%
      select(matches("^adm\\d_"))
  ) %>%
  set_names(c("adm0", "adm1", "adm2"))

fp_fs <-   file.path(
    Sys.getenv("AA_DATA_DIR"),
    "private",
    "raw",
    "glb",
    "floodscan",
    "floodscan_flooded_fraction_africa_19980112-20221231_p00",
    "aer_sfed_area_300s_19980112_20221231_v05r01.nc"
  )



tnc_fs <- tidync(fp_fs)
tnc_fs_filt <- fs_filter_bounds(fs_obj = tnc_fs,geometry = som_adm$adm0)
r_fs <- fs_to_raster(fs_obj = tnc_fs_filt,band = "SFED_AREA")

dir_wp <-  file.path(
  Sys.getenv("AA_DATA_DIR"),
  "public",
  "raw",
  "som",
  "worldpop"
)
fp_wp <-  file.path(
  dir_wp,
  "som_ppp_2020_1km_Aggregated_UNadj.tif" 
)
r_wp <-  rast(fp_wp)

```

```{r dfElNino}
# this is just for qual visuals
# El Nino year - Just from Wikipedia for a first glance
df_el_nino_years <- tibble(
  date = 
    c("1982-1983",
      "1997-1998",
      "2002-2003",
      "2004-2005",
      "2006-2007",
      "2009-2010",
      "2014-2016",
      "2018-2019",
      "2023-2024"
    )
) %>% 
  separate(
    date ,into = c("start_date","end_date"),sep = "-"
  ) 

# fomat data.frame for ggplot
df_el_nino_years <- df_el_nino_years %>% 
  mutate(
    start_date= glue("{start_date}-01-01") %>% as_date(),
    end_date = glue("{end_date}-12-31") %>% as_date()
  )
```

# Population Exposed to Flooding (FloodScan + World Pop)

Population exposed to flooding is derived by combining FloodScan and World Pop in the following process:

1. Calculate maximum flood scan fraction per a. month and, b. year at the pixel level (max composites)

```{r calcFSMaxComposites}
# This chunk calculates maximum floodscan fraction per month and year

# make a lookup table to be used for raster manipulations
fs_mos<- floor_date(as_date(names(r_fs)),"month")

fs_lookup <- tibble(
  fs_name = as_date(names(r_fs))
) %>% 
  mutate(
    fs_mo = floor_date(fs_name,"month"),
    fs_yr = floor_date(fs_name,"year")
  ) 

# calculate max floodscan fraction per month (pixel level)
lr_monthly_max <- unique(fs_lookup$fs_mo) %>% 
  map(
    \(mo_tmp){
      rname_temp<- fs_lookup %>% 
        filter(fs_mo==mo_tmp) %>% 
        pull(fs_name)
      r_fs_tmp <- r_fs[[names(r_fs) %in% rname_temp]]
      r_max <- max(r_fs_tmp)
      r_max %>% 
        set.names(mo_tmp)
      return(r_max)
    }
  )
# convert list of max rasters back to raster stack
r_fs_monthly_max <-  rast(lr_monthly_max)

# do the same, but this time per year
lr_yearly_max <- unique(fs_lookup$fs_yr) %>% 
  map(
    \(yr_tmp){
      rname_temp<- fs_lookup %>% 
        filter(fs_yr==yr_tmp) %>% 
        pull(fs_name)
      r_fs_tmp <- r_fs[[names(r_fs) %in% rname_temp]]
      r_max <- max(r_fs_tmp)
      r_max %>% 
        set.names(yr_tmp)
      return(r_max)
    }
  )

r_fs_yearly_max <-  rast(lr_yearly_max)
```

2. Align and resample FloodScan max composites to World Pop raster

```{r preProcessFloodScan}
#' Process max composites so they can be combined w/ world pop raster
#' Set extents & resample

# set extents to be equal
r_fs_monthly_max_crop <- crop(r_fs_monthly_max, r_wp)
r_fs_yearly_max_crop <- crop(r_fs_yearly_max, r_wp)
ext(r_fs_monthly_max_crop) <- ext(r_wp)
ext(r_fs_yearly_max_crop) <- ext(r_wp)

system.time(
r_fs_monthly_resampled <- terra::resample(x = r_fs_monthly_max_crop,r_wp)  
)

system.time(
r_fs_yearly_resampled <- terra::resample(x = r_fs_yearly_max_crop,r_wp)  
)

```

3. Multiply resampled FloodScan max composites by World Pop population estimate raster. From this we have a new rasters representing the population exposed per month/year.
```{r multFloodScanWorldPop}
#' Multiply resampled floodscan and world pop data
r_fs_mo_wp<- r_fs_monthly_resampled * r_wp
r_fs_yr_wp<- r_fs_yearly_resampled * r_wp
```

4. From the new rasters we can simply run zonal sums per admin zone of interest. Here we do it mainly by admin 1.

```{r calcZonalStats}

# Monthly Pop Exposed Per Admin 1
df_adm1_mo_pop_exposed<- exact_extract(x = r_fs_mo_wp,
                                y = som_adm$adm1, 
                                fun ="sum",
                                append_cols= c("adm1_en","adm1_pcode")
                                ) %>% 
  pivot_longer(-matches("adm")) %>%
  separate(name,
           into = c("stat", "date"),
           sep = "\\.") %>% 
  mutate(
    date= as_date(date)
  )

# Monthly Pop Exposed per Admin 2
df_adm2_mo_pop_exposed<- exact_extract(x = r_fs_mo_wp,
                                y = som_adm$adm2, 
                                fun ="sum",
                                append_cols= c("adm1_en","adm1_pcode","adm2_en","adm2_pcode")
                                ) %>% 
  pivot_longer(-matches("adm")) %>%
  separate(name,
           into = c("stat", "date"),
           sep = "\\.")%>% 
  mutate(
    date= as_date(date)
  )


# Yearly Pop Exposed per Admin 1
df_adm1_yr_pop_exposed <- exact_extract(x = r_fs_yr_wp,
                                y = som_adm$adm1, 
                                fun ="sum",
                                append_cols= c("adm1_en","adm1_pcode")
                                ) %>% 
  pivot_longer(-matches("adm")) %>%
  separate(name,
           into = c("stat", "date"),
           sep = "\\.") %>% 
  mutate(
    date= as_date(date)
  )



# World Pop Adin 1 Stats (Population per admin 1)
df_adm1_wp<- exact_extract(x = r_wp,
                                y = som_adm$adm1, 
                                fun ="sum",
                                append_cols= c("adm1_en","adm1_pcode")
                                ) %>% 
  pivot_longer(-matches("adm")) %>%
  separate(name,
           into = c("stat", "date"),
           sep = "\\.") %>% 
  mutate(date=as_date(date))

```

## Plot Population Exposed per Month
```{r plot-monthlyExposedAdm1, results= "asis"}
# Population expose
df_adm1_mo_pop_exposed %>% 
  ggplot(
    aes(x= date, y = value, group=adm1_en)
    )+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
  labs(title = "Monthly population exposed to flooding",
       y= "Population exposed",
       caption= "Population: World Pop\nFlood: FloodScan")+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90, size=7),
    axis.title.x =  element_blank(),
    plot.caption = element_text(hjust=0 , size=7),
    strip.text = element_text(size=9),
    panel.background = element_rect(color="grey",fill=NA)
  )
```

## Plot Population Exposed per year

```{r plot-yearlyExposedAdm1, results="asis"}
df_adm1_yr_pop_exposed %>% 
  ggplot(aes(x= date, y = value, group=adm1_en))+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
  labs(title = "Yearly population exposed to flooding",
       y= "Population exposed",
       caption= "Population: World Pop\nFlood: FloodScan")+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90),
    axis.text.y = element_text(size= 8),
    axis.title.x =  element_blank(),
    axis.title.y =  element_text(size=8),
    plot.caption = element_text(hjust=0, size= 7),
    strip.text = element_text(size=9),
    panel.background = element_rect(color="grey",fill=NA)
  )
```

## Flood Exposure Anomalies

From the admin level population exposed rasters we can easily calculate two types of anomalies:

1. Monthly difference from mean expsure
2. Monthly Z-score (difference from mean/ standard deviation)

```{r calcFloodExposureAnom}
# calc anomaly
df_adm1_mo_pop_exposed_anom <- df_adm1_mo_pop_exposed %>% 
  mutate(
    mo = month(date, label=T)
  ) %>% 
  group_by(adm1_en, adm1_pcode, mo) %>% 
  mutate(
    mean = mean(value),
    stdev = sd(value),
    diff_mean = value-mean,
    z_score = diff_mean/stdev
  ) %>% 
  ungroup()
```

### Plot difference from mean exposure

```{r plot-monthlyDiffAnomaly,results="asis"}
# difference from mean anomaly
df_adm1_mo_pop_exposed_anom %>% 
  ggplot(aes(x= date, y = diff_mean, group=adm1_en))+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
    labs(title = "Monthly Flood Exposure Anomaly",
       y= "Population exposed Anomaly (difference from average)",
       caption= "Population: World Pop\nFlood: FloodScan"
       )+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90),
    axis.text.y = element_text(size= 8),
    axis.title.x =  element_blank(),
    axis.title.y =  element_text(size=8),
    plot.caption = element_text(hjust=0, size= 7),
    strip.text = element_text(size=9),
    panel.background = element_rect(color="grey",fill=NA)
  )
```

### Plot Exposure Anomaly (Z-score)

```{r plot-MonthlyZscore, results="asis"}

df_adm1_mo_pop_exposed_anom %>% 
  ggplot()+
  geom_line(
    aes(x= date,
        y = z_score,
        group=adm1_en)
  )+
  scale_y_continuous(
    labels = scales::label_comma()
  )+
  labs(title = "Monthly Flood Exposure Anomaly",
       y= "Population exposed Anomaly (Z-score)",
       caption= "Population: World Pop\nFlood: FloodScan"
       )+
  facet_wrap(~adm1_en)+
  geom_rect(
    data= df_el_nino_years,
    aes(
      xmin = start_date,
      xmax = end_date,
      ymin = -Inf,
      ymax = Inf
    ),
    alpha = 0.2,
    fill = hdx_hex("tomato-hdx")
  )+
    scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y",
    limits = c(min(df_adm1_mo_pop_exposed_anom$date),as_date("2025-06-01")),
    expand = c(0,0)
  )+
  theme(
   axis.text.x = element_text(angle=90),
    axis.text.y = element_text(size= 8),
    axis.title.x =  element_blank(),
    axis.title.y =  element_text(size=8),
    plot.caption = element_text(hjust=0, size= 7),
    strip.text = element_text(size=9),
    panel.background = element_rect(color="grey",fill=NA)
  )
```

# Appendix

## FloodScan WorldPop Exposure Vs PRMN

```{r readPRMN}

dir_som_pub_raw <- file.path(
  Sys.getenv("AA_DATA_DIR"),
  "public",
  "raw",
  "som")

fp_prmn <- file.path(dir_som_pub_raw,
          "prmn",
          "UNHCR-PRMN-Displacement-Dataset.xlsx"
          )
df_prmn <- read_xlsx(fp_prmn) %>% 
  clean_names()

df_prmn <-  df_prmn %>% 
  filter(reason=="Flood") %>% 
  mutate(
    date= dmy(month_end),
    yr_mo = floor_date(date, "month"),
    .before= everything()
  )

df_prmn_adm1_mo <- df_prmn %>% 
  group_by(
    adm1_en = current_arrival_region,
    date= yr_mo
    ) %>% 
  summarise(
   number_of_individuals= sum(number_of_individuals,na.rm=T) ,
   .groups="drop"
  )
```


```{r joinFloodScanPRMN}
df_fs_prmn <- df_adm1_mo_pop_exposed_anom %>% 
  left_join(
    df_prmn_adm1_mo,
    by = c("date"="date",
           "adm1_en"="adm1_en")
  ) 
```

```{r plot-FloodScanVsPrmn, fig.height=9, results="asis"}
df_fs_prmn %>% 
  ggplot(aes(x= value, y= number_of_individuals))+
  geom_point(size=0.7)+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_continuous(labels = scales::label_comma())+
  labs(
    title = "Floodscan/World Pop vs PRMN Displacement by Admin 1",
    x= "Pop Exposure (FloodScan + World Pop)",
    y= "Number Displaced (PRMN)",
    caption= "Population: World Pop\nFlood: FloodScan\nDisplacement: UNHCR PRMN"
  )+
  facet_wrap(~adm1_en, scale="free")+
  theme(
    axis.text.x = element_text(angle=90),
    axis.text.y = element_text(size= 8),
    axis.title.x =  element_blank(),
    axis.title.y =  element_text(size=8),
    plot.caption = element_text(hjust=0, size= 7),
    strip.text = element_text(size=9),
    panel.background = element_rect(color="grey",fill=NA)
  )
```


```{r, eval =F}
df_fs_prmn_seas <- df_fs_prmn %>% 
  mutate(
    seas = case_when(
      month(date) %in% c(3,4,5)~"MAM",
      month(date)%in% c(10,11,12)~"OND"
    )
  ) %>% 
  filter(!is.na(seas)) %>% 
  group_by(across(matches("adm")),
                  yr=floor_date(date,"year"),seas) %>% 
  summarise(
    number_of_individuals= sum(number_of_individuals,na.rm=T),
    mean_z= mean(z_score),
    max_z= max(z_score),.groups="drop"
  ) 


df_fs_prmn_seas %>% 
  filter(seas== "MAM") %>% 
  ggplot(aes(x= mean_z, y= number_of_individuals))+
  geom_point()+
  facet_wrap(~adm1_en, scales="free")


df_fs_prmn_seas %>% 
  filter(seas== "OND") %>% 
  ggplot(aes(x= mean_z, y= number_of_individuals))+
  geom_point()+
  facet_wrap(~adm1_en,scales = "free")

# max OND
df_fs_prmn_seas %>% 
  filter(seas== "OND") %>% 
  ggplot(aes(x= max_z, y= number_of_individuals))+
  geom_point()+
  facet_wrap(~adm1_en,scales="free")
```


## Baidoa case study
```{r wrangleBaidoa}
df_prmn_baidoa_fs <- 
  left_join(
    df_adm2_mo_pop_exposed %>% 
      filter(year(date)>=2016,
             adm2_en=="Baydhaba") ,
  df_prmn %>% 
  filter(
   previous_departure_district== "Baidoa"
  ) %>% 
     group_by(date= yr_mo) %>% 
  summarise(
    number_of_individuals= sum(number_of_individuals,na.rm=T)
  ) ,
  by = c("date"="date")
  )
```

### Plot - Pop displaced & Exposed
```{r plot-BaidoaPopExposed,results="asis"}
df_prmn_baidoa_fs  %>% 
  select(
    adm2_en, date, `PRMN Displaced individuals`=number_of_individuals, `FloodScan + WorldPop Displaced` =value
  ) %>% 
  pivot_longer(`PRMN Displaced individuals`:`FloodScan + WorldPop Displaced`,
               names_to = "variable",
               values_to = "value") %>% 
  ggplot(
    aes(x= date, 
        y= value, 
        fill= variable, 
        group= variable, 
        color = variable
    )
    
    )+
  geom_point(alpha=0.8)+
  geom_line(alpha=0.5)+
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")+
    labs(
    title = "Baidoa - PRMN Displacement and FloodScan/WorldPop Exposure",
    y= "Exposed/Displaced",
    caption= "Population: World Pop\nFlood: FloodScan\nDisplacement: UNHCR PRMN"
  )+
  theme(
   axis.text.x = element_text(angle=90),
    axis.text.y = element_text(size= 8),
    axis.title.x =  element_blank(),
    axis.title.y =  element_text(size=8),
    plot.caption = element_text(hjust=0, size= 7),
    strip.text = element_text(size=9),
    panel.background = element_rect(color="grey",fill=NA)
   
  )
```

### Plot - Pop displaced & Exposed
```{r plot-BaidoaDualPopExposed,results="asis"}
df_prmn_baidoa_fs  %>% 
  select(
    adm2_en, date, number_of_individuals, value
  ) %>% 
  ggplot(
    aes(x= date, y= number_of_individuals)
    )+
  geom_point()+
  geom_line()+
   geom_vline(
     data = . %>% 
       filter(!is.na(number_of_individuals)),
    aes(xintercept = date), 
    color="red",alpha= 0.3
  )+
  geom_line(
    data= df_prmn_baidoa_fs,
    aes(x= date, y= value/10),
    color = hdx_hex("mint-hdx")
  )+
  scale_y_continuous(
    sec.axis = sec_axis(~.*10, name = "WorldPop Exposure (thousands)")
    )+
  scale_x_date(
    date_breaks = "1 month",
    date_labels = "%b%y", 
    limits = as_date(c("2016-01-01","2022-12-01")),expand = c(0,0)
    )+
  labs(
    y= "PRMN - Number of Individuals",
    title= "Somalia Baidoa - Displaced vs Flood Exposure",
    subtitle = "Blue dots and vertical red lines indicate PRMN Flood Displacement",
    caption= "Population: World Pop\nFlood: FloodScan\nDisplacement: UNHCR PRMN"
  )+
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle=90),
    axis.text.y = element_text(size= 8),
    axis.title.x =  element_blank(),
    axis.title.y =  element_text(size=8),
    plot.caption = element_text(hjust=0, size= 7),
    strip.text = element_text(size=9),
    panel.background = element_rect(color="grey",fill=NA)
    
  )
```

### Plot - Pop displaced & Exposed (pseudolog)
```{r plot-BaidoaDualPopExposedPseudo,results="asis"}
df_prmn_baidoa_fs  %>% 
  select(
    adm2_en, date, number_of_individuals, value
  ) %>% 
  ggplot(
    aes(x= date, y= number_of_individuals)
    )+
  geom_point()+
  geom_line()+
   geom_vline(
     data = . %>% 
       filter(!is.na(number_of_individuals)),
    aes(xintercept = date), 
    color="red",alpha= 0.3
  )+
  geom_line(
    data= df_prmn_baidoa_fs,
    aes(x= date, y= value/10)
  )+
  scale_y_continuous(
    trans = scales::pseudo_log_trans(),
    breaks = c(05,25,50,seq(100,1000, 200),2000,3000,9000),
    sec.axis = sec_axis(
      ~.*10, 
      name = "WorldPop Flood Exposure (thousands)",
      breaks= c(50,250,500,1000,10000,20000,30000,60000,90000)
      )
    )+
  scale_x_date(date_breaks = "1 month", date_labels = "%b%y")+
  labs(
    y= "PRMN - Number of Individuals",
    title= "Somalia Baidoa - Displaced vs Flood Exposure",
    subtitle = "Blue dots and vertical red lines indicate PRMN Flood Displacement",
    caption= "Population: World Pop\nFlood: FloodScan\nDisplacement: UNHCR PRMN"
  )+
    theme(
    legend.position = "none",
    axis.text.x = element_text(angle=90),
    axis.text.y = element_text(size= 8),
    axis.title.x =  element_blank(),
    axis.title.y =  element_text(size=8),
    plot.caption = element_text(hjust=0, size= 7),
    strip.text = element_text(size=9),
    panel.background = element_rect(color="grey",fill=NA)
    
  )
  
  
```


```{r animationSetup}
gdf_adm1_yr_pop_exposed <- som_adm$adm1 %>% 
  left_join(
    df_adm1_yr_pop_exposed,
    by = c("adm1_en"="adm1_en")
  ) 

# use ggplot2 to create a map using gdf_adm1_fly_yr
# I want to fill by the `value` column and I want to 
# annimate with gganimate by the `date` column


# this produces : Error: arguments have different crs 
# devtools::install_github("thomasp85/transformr")
# animate so that the color of the fill changes value based on date
# go through all the dates
# https://github.com/thomasp85/gganimate/issues/479

# create a ggplot object
p <- gdf_adm1_yr_pop_exposed %>% 
  ggplot() +
  geom_sf(aes(fill=value)) +
  scale_fill_viridis_c() +
  theme_void() +
  theme(legend.position = "bottom") +
  # transition_states and make each state last 1 second 
  transition_states(states = date,
                    # state_length = 2,
                    wrap = FALSE) +
  labs(title = "Flooding Exposure - {closest_state}",
       subtitle = "World Pop + Floodscan",
       fill = "Population Exposed"
       )

map_gif <- animate(p, 
        fps = 2,
        width = 800,
        height = 600)


# create ggplot line plot that adds a new year of data every time from df_zonal_fl_pop_yr 
# and animate with gganimate

p_facet_plot <- df_adm1_yr_pop_exposed %>% 
  mutate(
    date= as_date(date)
  ) %>% 
  ggplot(aes(x= date, y = value))+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
  labs()+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90),
    axis.title.x =  element_blank()
  )+
  transition_reveal(date)

plot_gif <- animate(p_facet_plot, 
        fps = 2,
        width = 800,
        height = 600)



map_mgif <- image_read(map_gif)
plot_mgif <- image_read(plot_gif)
length(map_mgif)
length(plot_mgif)


new_gif <- image_append(c(map_mgif[1], plot_mgif[1]))

for(i in 2:92){
  print(i)
  combined <- image_append(c(map_mgif[i], plot_mgif[i]))
  new_gif <- c(new_gif, combined)
}
```

```{r FunAnimation,results= "asis"}
new_gif
```






