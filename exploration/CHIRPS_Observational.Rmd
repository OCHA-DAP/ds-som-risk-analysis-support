---
title: "CHIRPS Observational"
output: html_document
date: "2023-09-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(tidyverse)
library(glue)

historical_baseline_ref <-  c(1981:2010)

df_chirps <- read_csv(file.path(
  Sys.getenv("AA_DATA_DIR"),
  "public",
  "processed",
  "som",
  "chirps",
  "20230926_chirps_monthly_historical_adm0.csv"
))

# El Nino year - Just from Wikipedia for a first glance
df_el_nino_years <- tibble(
  date = 
    c("1982-1983",
      "1997-1998",
      "2002-2003",
      "2004-2005",
      "2006-2007",
      "2009-2010",
      "2014-2016",
      "2018-2019",
      "2023-2024"
    )
) %>% 
  separate(
    date ,into = c("start_date","end_date"),sep = "-"
  ) 

# fomat data.frame for ggplot
df_el_nino_years <- df_el_nino_years %>% 
  mutate(
    start_date= glue("{start_date}-01-01") %>% as_date(),
    end_date = glue("{end_date}-12-31") %>% as_date()
  )
```


# Jan-August cumulative historical rainfall

```{r plotJFMAMJJA}

df_to_august <- df_chirps %>% 
  mutate(
    cat = case_when(
      month(date) %in% c(1:8)~ "up_to_current",
      .default =NA
    )
  ) %>% 
  filter(!is.na(cat)) %>% 
  group_by(across(matches("adm")),date=floor_date(date,"year")) %>% 
  summarise(
    rainfall_mm = sum(value),
    .groups="drop"
  ) 


df_to_august_top5_dry <- df_to_august %>% 
  group_by(across(matches("adm"))) %>% 
  slice_min(order_by = rainfall_mm,n = 5) %>% 
  ungroup() %>% 
  mutate(
    adm0_date = paste0(adm0_en,"_",date)
  )

df_august_2023 <- df_to_august %>% 
  filter(year(date)==2023)

rain_quantiles <- quantile(x = df_to_august$rainfall_mm,,
                           # probabilities of 0.1, 0.3, 0.5, 0.7, 0.9
                           probs = seq(0.1, 0.9, by = 0.2))

linetypes <- c("dashed", "dotted", "dotdash", "longdash", "twodash",
              "1F", "4C88C488", "12345678")



df_to_august %>% 
  mutate(
    adm0_date = paste0(adm0_en,"_",date),
    pt_color = adm0_date %in% df_to_august_top5_dry$adm0_date,
    pt_label = ifelse(adm0_date %in% df_to_august_top5_dry$adm0_date,year(date),NA),
    linetype = sample(linetypes, n(), replace = TRUE),
    
    image_size = case_when(
      rainfall_mm <= rain_quantiles[1] ~ 0.008,
      rainfall_mm <= rain_quantiles[2] ~ 0.011,
      rainfall_mm <= rain_quantiles[3] ~ 0.012,
      rainfall_mm <= rain_quantiles[4] ~ 0.014,
      rainfall_mm <= rain_quantiles[5] ~ 0.017,
      rainfall_mm > rain_quantiles[5] ~ 0.02,
      TRUE  ~ NA_real_
    )
  ) %>% 
  ggplot()+
  geom_rect(
    data= df_el_nino_years,
    aes(
      xmin = start_date,
      xmax = end_date,
      ymin = -Inf,
      ymax = Inf
    ),
    alpha = 0.2,
    fill = hdx_hex("tomato-hdx")
  )+
   ggimage::geom_image(aes(
     x= date, 
     y= rainfall_mm,
     color=pt_color,
     size = I(image_size),
                          # The I() above allows ggimage to read values "as-is"
                          image = 'https://labs.waterdata.usgs.gov/visualizations/23_chart_challenge/raindrop.png'),
                      # Aspect ratio
                      asp = 1.9
     
  )+
  scale_color_manual(values = c("#7FCDEE",hdx_hex("tomato-hdx")))+
  geom_linerange(aes(x=date, y=rainfall_mm,ymin = min(rainfall_mm), ymax = rainfall_mm, linetype = linetype),
                 color = "#7FCDEE") +
  scale_y_reverse()+
  scale_x_date(date_breaks = "2 year",date_labels = "%Y",
               limits = as.Date(c("1981-01-01", "2024-12-31"))#,
               # expand = c(0,0)
               # expand = c(as_date("1981-01-01"), as_date("2023-01-01"))
  )+
   labs(
    y = "Rainfall Total (mm)",
    title = "Somalia: Total January-August Rainfall by Year (CHIRPS)",
    subtitle = "Vertical red bars indicate el nino year")+
  
  theme(
    axis.text.x = element_text(angle= 90),
    legend.position = 'none',
    axis.title.x = element_blank(),
    panel.border = element_rect(color="grey", fill=NA)
    
  )
  # geom_text(aes(x=date, y=rainfall_mm,label=pt_label),nudge_y = 40)


  geom_point(aes(x=date, y= rainfall_mm,color=pt_color))+
  geom_text(aes(x=date, y=rainfall_mm,label=pt_label),nudge_y = 40)+
  
  geom_hline(
    data= df_august_2023,
    aes(yintercept=rainfall_mm),
    linetype="dashed",
    color=hdx_hex("tomato-hdx")
  )+
  scale_x_date(date_breaks = "2 year",date_labels = "%Y",
               limits = as.Date(c("1981-01-01", "2024-12-31")),
               expand = c(0,0)
               # expand = c(as_date("1981-01-01"), as_date("2023-01-01"))
  )+
  scale_y_reverse_hdx()+
  labs(
    y = "Rainfall Total (mm)",
    title = "Total January-August Rainfall by Year (CHIRPS)",
    subtitle = "Vertical red bars indicate el nino years, horizontal dashed line are 2023 values")+
  theme(
    axis.text.x = element_text(angle= 90),
    legend.position = 'none',
    axis.title.x = element_blank(),
    panel.border = element_rect(color="grey", fill=NA)
    
  )
```


# June-July-August cumulative historical rainfall

```{r plotJJA}
df_jja <- df_chirps %>% 
  mutate(
    cat = case_when(
      month(date) %in% c(6:8)~ "JJA",
      .default =NA
    )
  ) %>% 
  filter(!is.na(cat)) %>% 
  group_by(ADM0_NAME,date=floor_date(date,"year")) %>% 
  summarise(
    rainfall_mm = sum(value),
    .groups = "drop"
  ) 
df_jja_top5_dry <- df_jja %>% 
  group_by(ADM0_NAME) %>% 
  slice_min(order_by = rainfall_mm,n = 5) %>% 
  ungroup() %>% 
  mutate(
    adm0_date = paste0(ADM0_NAME,"_",date)
  )

df_jja2023<- df_jja %>% 
  filter(year(date)==2023)

df_jja %>% 
  mutate(
    adm0_date = paste0(ADM0_NAME,"_",date),
    pt_color = adm0_date %in% df_jja_top5_dry$adm0_date,
    pt_label = ifelse(adm0_date %in% df_jja_top5_dry$adm0_date,year(date),NA)
  ) %>% 
  ggplot()+
  geom_rect(
    data= df_el_nino_years,
    aes(
      xmin = start_date,
      xmax = end_date,
      ymin = -Inf,
      ymax = Inf
    ),
    alpha = 0.2,
    fill = hdx_hex("tomato-hdx")
  )+
  geom_point(aes(x=date, y= rainfall_mm,color=pt_color))+
  geom_text(aes(x=date, y=rainfall_mm,label=pt_label),nudge_y = 40)+

  geom_hline(
    data= df_jja2023,aes(yintercept=rainfall_mm),
    linetype="dashed",
    color=hdx_hex("tomato-hdx")
             )+
  facet_wrap(~ADM0_NAME)+
  scale_x_date(date_breaks = "2 year",date_labels = "%Y",
               limits = as.Date(c("1981-01-01", "2024-12-31")),
               expand = c(0,0)
               # expand = c(as_date("1981-01-01"), as_date("2023-01-01"))
               )+
  scale_y_reverse_hdx()+
  labs(
    y = "Rainfall Total (mm)",
    title = "Total JJA Rainfall by Year (CHIRPS)",
       subtitle = "Vertical red bars indicate el nino years, horizontal dashed line are 2023 values")+
  theme(
    axis.text.x = element_text(angle= 90),
    legend.position = 'none',
    axis.title.x = element_blank(),
    panel.border = element_rect(color="grey", fill=NA)
    
  )

```


```{r}
df_chirps_historical <- df_chirps %>% 
  filter(
    year(date) %in% historical_baseline_ref
  )

df_baseline_monthly <- df_chirps_historical %>% 
  group_by(month = month(date)) %>% 
  summarise(
    mean_precip = mean(value)
  )
df_historical <- df_chirps %>% 
  group_by(month = month(date)) %>% 
  summarise(
    mean_precip = mean(value)
  )

#. rainiest months - same in both all historical and 
rainiest_months_baseline <- df_baseline_monthly %>% 
  slice_max(order_by = mean_precip,n = 3)

rainiest_months_historical <- df_historical %>% 
  slice_max(order_by = mean_precip,n = 3)



df_chirps_anomaly <- df_chirps %>% 
  mutate(
    month = month(date)
  ) %>% 
  left_join(
    df_historical_monthly_mean,
    by= "month"
  ) %>% 
  mutate(
    diff_mean = value - mean_precip
  )

top10_anomalys<- df_chirps_anomaly %>% 
  slice_max(order_by = -diff_mean, n = 10)

df_chirps_anomaly %>% 
  slice_max(order_by = -diff_mean, n = 10)

df_chirps_anomaly %>% 
  slice_max(order_by = value, n = 10)


df_chirps_anomaly

df_chirps_anomaly %>% 
  ggplot(
    aes(x= date, y= diff_mean)
  )+
  geom_point()+
  scale_x_date(breaks = "1 year", date_labels = "%Y")+
  theme(
    axis.text.x = element_text(angle=90)
  )

df_chirps_anomaly %>% 
  mutate(
    anomaly_top10 = date %in% top10_anomalys$date
  ) %>% 
  ggplot(
    aes(x= date, y= value, color= anomaly_top10)
  )+
  geom_point()+
  scale_x_date(breaks = "1 year", date_labels = "%Y")+
  theme(
    axis.text.x = element_text(angle=90)
  )
```

# MAM anomaly - National Level
```{r}
df_mam_baseline <- df_chirps %>% 
  filter(
    year(date) %in% historical_baseline_ref,
    month(date) %in% c(3,4,5)
  )
mam_mean<- df_mam_baseline %>% 
  group_by(date=floor_date(date,"year")) %>% 
  summarise(
    mam_sum = sum(value)
  ) %>% 
  summarise(
    mam_mean = mean(mam_sum)
  )


 df_mam_anomaly <- df_chirps %>% 
  filter(
    month(date) %in% c(3,4,5)
  ) %>% 
   group_by(date=floor_date(date,"year")) %>% 
  summarise(
    mam_sum = sum(value)
  ) %>%
   mutate(
     mam_diff = mam_sum - mam_mean$mam_mean
   ) 
 
 df_mam_anomaly %>% 
   ggplot(
    
   )+
   geom_point(
      aes(x= date, y= mam_diff)
   )+
   geom_line(
      aes(x= date,
          y= mam_diff)
   )+
     geom_rect(
    data= df_el_nino_years,
    aes(
      xmin = start_date,
      xmax = end_date,
      ymin = -Inf,
      ymax = Inf
    ),
    alpha = 0.2,
    fill = hdx_hex("tomato-hdx")
  )+
   scale_x_date(
     date_break= "1 year",
     date_labels = "%Y"
   )+
   geom_hline(yintercept = 0,linetype="dashed",color=hdx_hex("tomato-hdx"))+
   labs(
     title = "Somalia MAM Yearly Rainfall Anomaly",
     subtitle ="Baseline MAM (1981-2010)",
     y= "Absolute difference from historical average (mm)"
   )+
   theme(
     axis.title.x = element_blank(),
     axis.text.x = element_text(angle = 90)
   )
```
# OND anomaly - National Level
```{r}
df_ond_baseline <- df_chirps %>% 
  filter(
    year(date) %in% historical_baseline_ref,
    month(date) %in% c(10,11,12)
  )
ond_mean<- df_ond_baseline %>% 
  group_by(date=floor_date(date,"year")) %>% 
  summarise(
    ond_sum = sum(value)
  ) %>% 
  summarise(
    ond_mean = mean(ond_sum)
  )


 df_ond_anomaly <- df_chirps %>% 
  filter(
    month(date) %in% c(10,11,12)
  ) %>% 
   group_by(date=floor_date(date,"year")) %>% 
  summarise(
    ond_sum = sum(value)
  ) %>%
   mutate(
     ond_diff = ond_sum - ond_mean$ond_mean
   ) 
 
 df_ond_anomaly %>% 
   ggplot(
    
   )+
   geom_point(
      aes(x= date, y= ond_diff)
   )+
   geom_line(
      aes(x= date,
          y= ond_diff)
   )+
     geom_rect(
    data= df_el_nino_years,
    aes(
      xmin = start_date,
      xmax = end_date,
      ymin = -Inf,
      ymax = Inf
    ),
    alpha = 0.2,
    fill = hdx_hex("tomato-hdx")
  )+
   scale_x_date(
     date_break= "1 year",
     date_labels = "%Y"
   )+
   geom_hline(yintercept = 0,linetype="dashed",color=hdx_hex("tomato-hdx"))+
   labs(
     title = "Somalia OND Yearly Rainfall Anomaly",
     subtitle ="Baseline OND (1981-2010)",
     y= "Absolute difference from historical average (mm)"
   )+
   theme(
     axis.title.x = element_blank(),
     axis.text.x = element_text(angle = 90)
   )
```

## MAM Admin 1 Level

```{r}
chirps_zonal_dir <- file.path(
  Sys.getenv("AA_DATA_DIR"),
  "public",
  "processed",
  "som",
  "chirps"
)
df_mam_ond<- read_csv(
  file.path(
    chirps_zonal_dir,
    "20231005_chirps_adm1_MAM_OND.csv" 
  )
)
df_mam_ond_baseline <- df_mam_ond %>% 
  filter(year(date) %in% historical_baseline_ref)

df_adm1_mam_ond_baseline_mean <- df_mam_ond_baseline %>% 
  group_by(adm1_en,
           adm1_pcode,
           mo= month(date)
           ) %>% 
  summarise(
    avg_historical = mean(value),
    .groups="drop"
  )

df_mam_ond_anomaly <- df_mam_ond %>%   
  mutate(
    mo = month(date),
    yr= year(date)
  ) %>% 
  left_join(df_adm1_mam_ond_baseline_mean) %>% 
  mutate(
    anomaly_absolute = value - avg_historical
  )
df_mam_ond_anomaly %>% 
  ggplot(
    aes(x= date,y = anomaly_absolute, color=adm1_en)
  ) +
  geom_point()+
  geom_line()+
  facet_wrap(~mo,nrow=2)

df_mam_ond_anomaly %>% 
  filter(mo ==3) %>% 
  ggplot(
    
  ) +
  geom_point(
    aes(x= date,y = anomaly_absolute)
  )+
  geom_line(
    aes(x= date,y = anomaly_absolute)
  )+
  geom_hline(yintercept =0, 
             linetype= "dashed", color=hdx_hex("tomato-hdx"))+
    geom_rect(
    data= df_el_nino_years,
    aes(
      xmin = start_date,
      xmax = end_date,
      ymin = -Inf,
      ymax = Inf
    ),
    alpha = 0.2,
    fill = hdx_hex("tomato-hdx")
  )+
  scale_x_date(
    date_breaks="2 year",
    date_labels = "%y"
  )+
  facet_wrap(~adm1_en)+
  labs(
    title = "Somalia MAM anomaly admin 1"
  )
df_mam_ond_anomaly %>% 
  filter(mo ==10) %>% 
  ggplot(
    
  ) +
  geom_point(
    aes(x= date,y = anomaly_absolute)
  )+
  geom_line(
    aes(x= date,y = anomaly_absolute)
  )+
  geom_hline(yintercept =0, 
             linetype= "dashed", color=hdx_hex("tomato-hdx"))+
    geom_rect(
    data= df_el_nino_years,
    aes(
      xmin = start_date,
      xmax = end_date,
      ymin = -Inf,
      ymax = Inf
    ),
    alpha = 0.2,
    fill = hdx_hex("tomato-hdx")
    )+
  scale_x_date(
    date_breaks="2 year",
    date_labels = "%y"
  )+
  facet_wrap(~adm1_en)+
  labs(
    title = "Somalia OND anomaly admin 1"
  )+
  theme(
    axis.text.x = element_text(angle=90,size=9)
  )



```


