---
title: "floodscan"
output: html_document
date: "2023-10-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(tidyverse)
library(sf)
library(tidync)
library(rhdx)
library(exactextractr)
library(janitor)
library(terra)
library(glue)
library(exactextractr)
source("R/utils_floodscan.R")
som_adm0_levels <- c(
  "som_admbnda_adm0_ocha_20230308",
  "som_admbnda_adm1_ocha_20230308",
  "som_admbnda_adm2_ocha_20230308"
)

som_adm <- som_adm0_levels %>%
  map(
    ~ search_datasets("Somalia - Subnational Administrative Boundaries") %>%
      pluck(1) %>%
      get_resource(2) %>%
      read_resource(layer = .x) %>%
      clean_names() %>%
      select(matches("^adm\\d_"))
  ) %>%
  set_names(c("adm0", "adm1", "adm2"))

fp_fs <-   file.path(
    Sys.getenv("AA_DATA_DIR"),
    "private",
    "raw",
    "glb",
    "floodscan",
    "floodscan_flooded_fraction_africa_19980112-20221231_p00",
    "aer_sfed_area_300s_19980112_20221231_v05r01.nc"
  )



tnc_fs <- tidync(fp_fs)
tnc_fs_filt <- fs_filter_bounds(fs_obj = tnc_fs,geometry = som_adm$adm0)
r_fs <- fs_to_raster(fs_obj = tnc_fs_filt,band = "SFED_AREA")

dir_wp <-  file.path(
  Sys.getenv("AA_DATA_DIR"),
  "public",
  "raw",
  "som",
  "worldpop"
)
fp_wp <-  file.path(
  dir_wp,
  "som_ppp_2020_1km_Aggregated_UNadj.tif" 
)
r_wp <-  rast(fp_wp)

```

```{r}
# El Nino year - Just from Wikipedia for a first glance
df_el_nino_years <- tibble(
  date = 
    c("1982-1983",
      "1997-1998",
      "2002-2003",
      "2004-2005",
      "2006-2007",
      "2009-2010",
      "2014-2016",
      "2018-2019",
      "2023-2024"
    )
) %>% 
  separate(
    date ,into = c("start_date","end_date"),sep = "-"
  ) 

# fomat data.frame for ggplot
df_el_nino_years <- df_el_nino_years %>% 
  mutate(
    start_date= glue("{start_date}-01-01") %>% as_date(),
    end_date = glue("{end_date}-12-31") %>% as_date()
  )
```


```{r}
fs_mos<- floor_date(as_date(names(r_fs)),"month")

fs_lookup <- tibble(
  fs_name = as_date(names(r_fs))
) %>% 
  mutate(
    fs_mo = floor_date(fs_name,"month"),
    fs_yr = floor_date(fs_name,"year")
  ) 


lr_monthly_max <- unique(fs_lookup$fs_mo) %>% 
  map(
    \(mo_tmp){
      rname_temp<- fs_lookup %>% 
        filter(fs_mo==mo_tmp) %>% 
        pull(fs_name)
      r_fs_tmp <- r_fs[[names(r_fs) %in% rname_temp]]
      r_max <- max(r_fs_tmp)
      r_max %>% 
        set.names(mo_tmp)
      return(r_max)
    }
  )
r_fs_monthly_max <-  rast(lr_monthly_max)

lr_yearly_max <- unique(fs_lookup$fs_yr) %>% 
  map(
    \(yr_tmp){
      rname_temp<- fs_lookup %>% 
        filter(fs_yr==yr_tmp) %>% 
        pull(fs_name)
      r_fs_tmp <- r_fs[[names(r_fs) %in% rname_temp]]
      r_max <- max(r_fs_tmp)
      r_max %>% 
        set.names(yr_tmp)
      return(r_max)
    }
  )
r_fs_monthly_max <-  rast(lr_monthly_max)
r_fs_yearly_max <-  rast(lr_yearly_max)


r_fs_monthly_max_crop<- crop(r_fs_monthly_max, r_wp)
r_fs_yearly_max_crop<- crop(r_fs_yearly_max, r_wp)
ext(r_fs_monthly_max_crop) <- ext(r_wp)
ext(r_fs_yearly_max_crop) <- ext(r_wp)

system.time(
r_fs_monthly_resampled <- terra::resample(x = r_fs_monthly_max_crop,r_wp)  
)

system.time(
r_fs_yearly_resampled <- terra::resample(x = r_fs_yearly_max_crop,r_wp)  
)

```

multiply world pop and fs
```{r}
r_fs_mo_wp<- r_fs_monthly_resampled * r_wp
r_fs_yr_wp<- r_fs_yearly_resampled * r_wp
```

# zonal stats flood scan
```{r}

rt <- rast("/Users/zackarno/Downloads/SOM_ppp_2020_adj_v2.tif")
df_zonal_fl_pop<- exact_extract(x = r_fs_mo_wp,
                                y = som_adm$adm1, 
                                fun ="sum",
                                append_cols= c("adm1_en","adm1_pcode")
                                ) %>% 
  pivot_longer(-matches("adm")) %>%
  separate(name,
           into = c("stat", "date"),
           sep = "\\.")
df_adm2_fl_pop<- exact_extract(x = r_fs_mo_wp,
                                y = som_adm$adm2, 
                                fun ="sum",
                                append_cols= c("adm1_en","adm1_pcode","adm2_en","adm2_pcode")
                                ) %>% 
  pivot_longer(-matches("adm")) %>%
  separate(name,
           into = c("stat", "date"),
           sep = "\\.")

# yearly max zonal
df_zonal_fl_pop_yr<- exact_extract(x = r_fs_yr_wp,
                                y = som_adm$adm1, 
                                fun ="sum",
                                append_cols= c("adm1_en","adm1_pcode")
                                ) %>% 
  pivot_longer(-matches("adm")) %>%
  separate(name,
           into = c("stat", "date"),
           sep = "\\.")




df_wp_adm1<- exact_extract(x = r_wp,
                                y = som_adm$adm1, 
                                fun ="sum",
                                append_cols= c("adm1_en","adm1_pcode")
                                ) %>% 
  pivot_longer(-matches("adm")) %>%
  separate(name,
           into = c("stat", "date"),
           sep = "\\.")

sum(df_rt_adm1$value)
sum(df_wp_adm1$value)

df_rt_adm1<- exact_extract(x = rt,
                                y = som_adm$adm1, 
                                fun ="sum",
                                append_cols= c("adm1_en","adm1_pcode")
                                ) %>% 
  pivot_longer(-matches("adm")) %>%
  separate(name,
           into = c("stat", "date"),
           sep = "\\.")

df_wp_adm1$value %>% sum()


df_zonal_fl_pop <- df_zonal_fl_pop %>% 
  mutate(
    date=as_date(date)
  )
  
df_zonal_fl_pop_yr <- df_zonal_fl_pop_yr %>% 
  mutate(
    date=as_date(date)
  )
  
```

```{r}
# Population expose
df_zonal_fl_pop %>% 
  ggplot(aes(x= date, y = value, group=adm1_en))+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
  labs(title = "Population exposed to flooding")+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90),
    axis.title.x =  element_blank()
  )

df_zonal_fl_pop_yr <- df_zonal_fl_pop_yr %>% 
  mutate(date= as_date(date))

df_zonal_fl_pop_yr %>% 
  ggplot(aes(x= date, y = value, group=adm1_en))+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
  labs(title = "Population exposed to flooding")+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90),
    axis.title.x =  element_blank()
  )

# total exposed per year - but this would have double counting
df_zonal_fl_pop %>% 
  group_by(across(starts_with("adm")),yr_mo = floor_date(date,"year")) %>% 
  summarise(
    value = sum(value),
    max_value = max(value)
  ) %>% 
  ggplot(aes(x= yr_mo, y = value, group=adm1_en))+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
  labs(title = "Population exposed to flooding")+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90),
    axis.title.x =  element_blank()
  )
df_zonal_fl_pop %>% 
  group_by(across(starts_with("adm")),yr_mo = floor_date(date,"year")) %>% 
  summarise(
    value = sum(value),
    max_value = max(value)
  ) %>% 
  ggplot(aes(x= yr_mo, y = max_value, group=adm1_en))+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
  labs(title = "Population exposed to flooding")+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90),
    axis.title.x =  element_blank()
  )

# calc anomaly
df_zonal_fl_pop_anom <- df_zonal_fl_pop %>% 
  mutate(
    date= as_date(date),
    mo = month(date, label=T)
  ) %>% 
  group_by(adm1_en, adm1_pcode, mo) %>% 
  mutate(
    mean = mean(value),
    stdev = sd(value),
    diff_mean = value-mean,
    z_score = diff_mean/stdev
  ) %>% 
  ungroup()
  

# difference from mean anomaly
df_zonal_fl_pop_anom %>% 
  ggplot(aes(x= date, y = diff_mean, group=adm1_en))+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
  labs()+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90),
    axis.title.x =  element_blank()
  )

# z score anomaly
df_zonal_fl_pop_anom %>% 
  ggplot()+
  geom_line(aes(x= date, y = z_score, group=adm1_en))+
  scale_y_continuous(labels = scales::label_comma())+

  labs(title = "Population Exposure to Flooding Anomaly",
       subtitle = "World pop + Floodscan"
         )+
  facet_wrap(~adm1_en)+
  # geom_vline(xintercept = as_date("2023-01-01"))+
  geom_rect(
    data= df_el_nino_years,
    aes(
      xmin = start_date,
      xmax = end_date,
      ymin = -Inf,
      ymax = Inf
    ),
    alpha = 0.2,
    fill = hdx_hex("tomato-hdx")
  )+
    scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y",
    limits = c(min(df_zonal_fl_pop_anom$date),as_date("2025-06-01")),
    expand = c(0,0)
  )+
  theme(
    axis.text.x = element_text(angle=90),
    axis.title.x =  element_blank(),
    panel.background = element_rect(color="grey",fill=NA)
  )
```

# Join w/ PRMN - by region
```{r}
library(readxl)
dir_som_pub_raw <- file.path(
  Sys.getenv("AA_DATA_DIR"),
  "public",
  "raw",
  "som")

fp_prmn <- file.path(dir_som_pub_raw,
          "prmn",
          "UNHCR-PRMN-Displacement-Dataset.xlsx"
          )
df_prmn <- read_xlsx(fp_prmn) %>% 
  clean_names()

df_prmn <-  df_prmn %>% 
  filter(reason=="Flood") %>% 
  mutate(
    date= dmy(month_end),
    yr_mo = floor_date(date, "month"),
    ,.before= everything()
  )


df_fs_prmn <- df_zonal_fl_pop_anom %>% 
  left_join(
    df_flood, by = c("date"="yr_mo",
                     "adm1_en"="previous_departure_region")
  ) 

df_fs_prmn %>% 
  ggplot(aes(x= value, y= number_of_individuals))+
  geom_point()+
  labs(x= "World Pop exposure from FloodScan")+
  facet_wrap(~adm1_en, scale="free")


df_fs_prmn_seas <- df_fs_prmn %>% 
  mutate(
    seas = case_when(
      month(date) %in% c(3,4,5)~"MAM",
      month(date)%in% c(10,11,12)~"OND"
    )
  ) %>% 
  filter(!is.na(seas)) %>% 
  group_by(across(matches("adm")),
                  yr=floor_date(date,"year"),seas) %>% 
  summarise(
    number_of_individuals= sum(number_of_individuals,na.rm=T),
    mean_z= mean(z_score),
    max_z= max(z_score),.groups="drop"
  ) 


df_fs_prmn_seas %>% 
  filter(seas== "MAM") %>% 
  ggplot(aes(x= mean_z, y= number_of_individuals))+
  geom_point()+
  facet_wrap(~adm1_en, scales="free")

df_fs_prmn_seas %>% 
  filter(seas== "MAM") %>% 
  ggplot(aes(x= max_z, y= number_of_individuals))+
  geom_point()+
  facet_wrap(~adm1_en,scales="free")

df_fs_prmn_seas %>% 
  filter(seas== "OND") %>% 
  ggplot(aes(x= mean_z, y= number_of_individuals))+
  geom_point()+
  facet_wrap(~adm1_en,scales = "free")

# max OND
df_fs_prmn_seas %>% 
  filter(seas== "OND") %>% 
  ggplot(aes(x= max_z, y= number_of_individuals))+
  geom_point()+
  facet_wrap(~adm1_en,scales="free")
```

```{r}
df_prmn_baidoa_fs <- df_prmn %>% 
  filter(
   previous_departure_district== "Baidoa"
  ) %>% 
  group_by(yr_mo) %>% 
  summarise(
    number_of_individuals= sum(number_of_individuals,na.rm=T)
  ) %>% 
  left_join(
    df_adm2_fl_pop %>% 
      mutate(
        date= as_date(date)
      ) %>% 
  filter(adm2_en=="Baydhaba") ,
  by = c("yr_mo"="date")
  )
df_prmn_baidoa_fs <- 
  left_join(
    df_adm2_fl_pop %>% 
      mutate(
        date= as_date(date)
      ) %>% 
      filter(year(date)>=2016,
             adm2_en=="Baydhaba") ,
  df_prmn %>% 
  filter(
   previous_departure_district== "Baidoa"
  ) %>% 
     group_by(yr_mo) %>% 
  summarise(
    number_of_individuals= sum(number_of_individuals,na.rm=T)
  ) ,
  by = c("date"="yr_mo")
  )

df_prmn_baidoa_fs  %>% 
  select(
    adm2_en, date, number_of_individuals, value
  ) %>% 
  pivot_longer(number_of_individuals:value,
               names_to = "variable",
               values_to = "value") %>% 
  ggplot(aes(x= date, y= value, fill= variable, group= variable, color = variable))+
  geom_point()+
  geom_line()

df_prmn_baidoa_fs  %>% 
  select(
    adm2_en, date, number_of_individuals, value
  ) %>% 
  ggplot(
    aes(x= date, y= number_of_individuals)
    )+
  geom_point()+
  geom_line()+
   geom_vline(
     data = . %>% 
       filter(!is.na(number_of_individuals)),
    aes(xintercept = date), 
    color="red",alpha= 0.3
  )+
  geom_line(
    data= df_prmn_baidoa_fs,
    aes(x= date, y= value/10),
    color = hdx_hex("mint-hdx")
  )+
  scale_y_continuous(
    # breaks = c(05,25,50,seq(100,1000, 200),2000,3000,9000),
    sec.axis = sec_axis(~.*10, name = "WorldPop Exposure (thousands)")
    )+
  scale_x_date(date_breaks = "1 month", date_labels = "%b%y")+
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 1)
  )+
  labs(
    y= "PRMN - Number of Individuals",
    title= "Baidoa - Displaced vs Flood Exposure",
    subtitle = "Displaced from PRMN data, flood exposure calculated from Floodscan & Worldpop"
  )
df_prmn_baidoa_fs  %>% 
  select(
    adm2_en, date, number_of_individuals, value
  ) %>% 
  ggplot(
    aes(x= date, y= number_of_individuals)
    )+
  geom_point()+
  geom_line()+
   geom_vline(
     data = . %>% 
       filter(!is.na(number_of_individuals)),
    aes(xintercept = date), 
    color="red",alpha= 0.3
  )+
  geom_line(
    data= df_prmn_baidoa_fs,
    aes(x= date, y= value/10)
  )+
  scale_y_continuous(
    trans = scales::pseudo_log_trans(),
    breaks = c(05,25,50,seq(100,1000, 200),2000,3000,9000),
    sec.axis = sec_axis(~.*10, name = "WorldPop Flood Exposure (thousands)")
    )+
  scale_x_date(date_breaks = "1 month", date_labels = "%b%y")+
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 1)
  )
  
  
```


```{r}
library(gghdx)
gghdx()
library(gganimate)
# install.packages("chattr")
gdf_adm1_fly_yr <- som_adm$adm1 %>% 
  left_join(
    df_zonal_fl_pop_yr,
    by = c("adm1_en"="adm1_en")
  ) 

# use ggplot2 to create a map using gdf_adm1_fly_yr
# I want to fill by the `value` column and I want to 
# annimate with gganimate by the `date` column


# this produces : Error: arguments have different crs 
# devtools::install_github("thomasp85/transformr")
# animate so that the color of the fill changes value based on date
# go through all the dates
# https://github.com/thomasp85/gganimate/issues/479

# create a ggplot object
p <- gdf_adm1_fly_yr %>% 
  ggplot() +
  geom_sf(aes(fill=value)) +
  scale_fill_viridis_c() +
  theme_void() +
  theme(legend.position = "bottom") +
  # transition_states and make each state last 1 second 
  transition_states(states = date,
                    # state_length = 2,
                    wrap = FALSE) +
  labs(title = "Flooding Exposure - {closest_state}",
       subtitle = "World Pop + Floodscan",
       fill = "Population Exposed"
       )

map_gif <- animate(p, 
        fps = 2,
        width = 800,
        height = 600)

nrow(gdf_adm1_fly_yr)
nrow(df_zonal_fl_pop_yr)
# create ggplot line plot that adds a new year of data every time from df_zonal_fl_pop_yr 
# and animate with gganimate

p_facet_plot <- df_zonal_fl_pop_yr %>% 
  mutate(
    date= as_date(date)
  ) %>% 
  ggplot(aes(x= date, y = value))+
  geom_line()+
  scale_y_continuous(labels = scales::label_comma())+
  scale_x_date(
    date_breaks = "1 year",
    date_labels= "%y"
  )+
  labs()+
  facet_wrap(~adm1_en)+
  theme(
    axis.text.x = element_text(angle=90),
    axis.title.x =  element_blank()
  )+
  transition_reveal(date)

plot_gif <- animate(p_facet_plot, 
        fps = 2,
        width = 800,
        height = 600)


library(magick)
map_mgif <- image_read(map_gif)
plot_mgif <- image_read(plot_gif)
length(map_mgif)
length(plot_mgif)


new_gif <- image_append(c(map_mgif[1], plot_mgif[1]))

for(i in 2:92){
  print(i)
  combined <- image_append(c(map_mgif[i], plot_mgif[i]))
  new_gif <- c(new_gif, combined)
}

new_gif
```

```{r}
```




